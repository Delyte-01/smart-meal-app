"use client";

import { useState } from "react";
import { Slider } from "@/components/ui/slider";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet";
import { Filter, ChefHat, Clock, Flame, X } from "lucide-react";
import { useRecipeStore } from "@/lib/store/recipeStore";

export default function MealFilters() {
  const { setFilters, setSort, getRecipes } = useRecipeStore();

  const [calories, setCalories] = useState<[number, number]>([0, 800]);
  const [time, setTime] = useState<[number, number]>([0, 60]);
  const [selectedCuisine, setSelectedCuisine] = useState<string | null>(null);
  const [selectedDiet, setSelectedDiet] = useState<string | null>(null);
  const [selectedIntolerances, setSelectedIntolerances] = useState<string[]>(
    []
  );
  const [selectedMealType, setSelectedMealType] = useState<string | null>(null);
  const [selectedSort, setSelectedSort] = useState<string | null>(null);

  const handleApply = () => {
    setFilters({
      cuisine: selectedCuisine || "",
      diet: selectedDiet || "",
      intolerances: selectedIntolerances.join(","),
      mealType: selectedMealType || "",
      calories,
      time,
    });
    if (selectedSort) {
      setSort(selectedSort);
    }
    getRecipes();
  };

  const handleReset = () => {
    setCalories([0, 800]);
    setTime([0, 60]);
    setSelectedCuisine(null);
    setSelectedDiet(null);
    setSelectedIntolerances([]);
    setSelectedMealType(null);
    setSelectedSort(null);
    setFilters({});
    setSort("");
    getRecipes();
  };

  const FilterContent = () => (
    <div className="space-y-8 py-6">
      {/* Cuisine */}
      <div>
        <label className="text-lg font-semibold flex items-center gap-2 mb-3">
          <ChefHat className="h-5 w-5 text-indigo-600" />
          Cuisine
        </label>
        <div className="flex gap-2 items-center">
          <Select
            onValueChange={(val) => setSelectedCuisine(val)}
            value={selectedCuisine || ""}
          >
            <SelectTrigger className="w-full h-12">
              <SelectValue placeholder="Any cuisine" />
            </SelectTrigger>
            <SelectContent>
              {[
                "Italian",
                "Mexican",
                "Indian",
                "Chinese",
                "Japanese",
                "Thai",
                "Mediterranean",
                "French",
              ].map((c) => (
                <SelectItem key={c} value={c.toLowerCase()}>
                  {c}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          {selectedCuisine && (
            <button
              onClick={() => setSelectedCuisine(null)}
              className="p-2 hover:bg-gray-100 rounded"
            >
              <X className="h-4 w-4" />
            </button>
          )}
        </div>
      </div>

      {/* Diet */}
      <div>
        <label className="text-lg font-semibold mb-3 block">Diet</label>
        <div className="flex gap-2 items-center">
          <Select
            onValueChange={(val) => setSelectedDiet(val)}
            value={selectedDiet || ""}
          >
            <SelectTrigger className="w-full h-12">
              <SelectValue placeholder="No preference" />
            </SelectTrigger>
            <SelectContent>
              {[
                "Vegetarian",
                "Vegan",
                "Keto",
                "Paleo",
                "Gluten Free",
                "Dairy Free",
              ].map((d) => (
                <SelectItem key={d} value={d.toLowerCase()}>
                  {d}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          {selectedDiet && (
            <button
              onClick={() => setSelectedDiet(null)}
              className="p-2 hover:bg-gray-100 rounded"
            >
              <X className="h-4 w-4" />
            </button>
          )}
        </div>
      </div>

      {/* Intolerances */}
      <div>
        <label className="text-lg font-semibold mb-3 block">
          Allergies & Intolerances
        </label>
        <div className="grid grid-cols-2 gap-3">
          {["Gluten", "Dairy", "Egg", "Peanut", "Soy", "Shellfish"].map(
            (item) => (
              <label
                key={item}
                className="flex items-center gap-3 cursor-pointer p-3 rounded-lg hover:bg-gray-50 transition"
              >
                <Checkbox
                  checked={selectedIntolerances.includes(item.toLowerCase())}
                  onCheckedChange={(checked) => {
                    if (checked) {
                      setSelectedIntolerances([
                        ...selectedIntolerances,
                        item.toLowerCase(),
                      ]);
                    } else {
                      setSelectedIntolerances(
                        selectedIntolerances.filter(
                          (i) => i !== item.toLowerCase()
                        )
                      );
                    }
                  }}
                />
                <span className="text-sm font-medium">{item}</span>
              </label>
            )
          )}
        </div>
      </div>

      {/* Calories Slider */}
      <div>
        <label className="text-lg font-semibold flex items-center gap-2 mb-4">
          <Flame className="h-5 w-5 text-orange-600" />
          Max Calories
        </label>
        <Slider
          value={calories}
          onValueChange={(val) => setCalories(val as [number, number])}
          max={1200}
          step={50}
          className="mb-2"
        />
        <div className="flex justify-between text-sm text-gray-600">
          <span>{calories[0]} cal</span>
          <span>{calories[1]} cal</span>
        </div>
      </div>

      {/* Time Slider */}
      <div>
        <label className="text-lg font-semibold flex items-center gap-2 mb-4">
          <Clock className="h-5 w-5 text-teal-600" />
          Max Cooking Time
        </label>
        <Slider
          value={time}
          onValueChange={(val)=> setTime(val as [number, number])}
          max={120} 
          step={5}
          className="mb-2"
        />
        <div className="flex justify-between text-sm text-gray-600">
          <span>{time[0]} min</span>
          <span>{time[1]} min</span>
        </div>
      </div>

      {/* Sort */}
      <div>
        <label className="text-lg font-semibold mb-3 block">Sort By</label>
        <div className="flex gap-2 items-center">
          <Select
            onValueChange={(val) => setSelectedSort(val)}
            value={selectedSort || ""}
          >
            <SelectTrigger className="w-full h-12">
              <SelectValue placeholder="Choose sorting" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Best match</SelectItem>
              <SelectItem value="popularity">Most Popular</SelectItem>
              <SelectItem value="healthiness">Healthiest First</SelectItem>
              <SelectItem value="time">Fastest</SelectItem>
              <SelectItem value="calories">Lowest Calories</SelectItem>
            </SelectContent>
          </Select>
          {selectedSort && (
            <button
              onClick={() => setSelectedSort(null)}
              className="p-2 hover:bg-gray-100 rounded"
            >
              <X className="h-4 w-4" />
            </button>
          )}
        </div>
      </div>

      {/* Buttons */}
      <div className="flex flex-col gap-3 pt-6 border-t">
        <Button
          onClick={handleApply}
          className="w-full h-12 text-lg font-bold bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700"
        >
          Apply Filters
        </Button>
        <Button variant="outline" onClick={handleReset} className="w-full h-12">
          Reset All
        </Button>
      </div>
    </div>
  );

  return (
    <>
      {/* Mobile: Sheet Filter */}
      <div className="md:hidden mb-6">
        <Sheet>
          <SheetTrigger asChild>
            <Button
              variant="outline"
              size="lg"
              className="w-full flex items-center justify-center gap-3"
            >
              <Filter className="h-5 w-5" />
              <span className="font-semibold">Filters & Sorting</span>
              <span className="ml-auto text-sm text-gray-500">
                {(selectedCuisine ||
                  selectedDiet ||
                  selectedIntolerances.length > 0 ||
                  selectedMealType ||
                  calories[0] !== 0 ||
                  calories[1] !== 800 ||
                  time[0] !== 0 ||
                  time[1] !== 60 ||
                  selectedSort) &&
                  "Active"}
              </span>
            </Button>
          </SheetTrigger>
          <SheetContent side="left" className="w-11/12 sm:w-96 overflow-y-auto">
            <SheetHeader className="text-left mb-6">
              <SheetTitle className="text-2xl font-bold">
                Refine Your Search
              </SheetTitle>
            </SheetHeader>
            <FilterContent />
          </SheetContent>
        </Sheet>
      </div>

      {/* Desktop: Sticky Sidebar */}
      <div className="hidden md:block w-full lg:w-80 xl:w-96">
        <div className="sticky top-6 bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
          <h2 className="text-2xl font-bold mb-8 flex items-center gap-3">
            <Filter className="h-6 w-6 text-indigo-600" />
            Filters
          </h2>
          <FilterContent />
        </div>
      </div>
    </>
  );
}
